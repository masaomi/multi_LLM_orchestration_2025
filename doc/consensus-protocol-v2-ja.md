# Consensus Protocol v2

## 概要

Consensus Protocol v2は、複数のLarge Language Model（LLM）を活用し、自動生成・相互評価・合意形成を通じて高品質なAI回答を実現するマルチLLMオーケストレーションフレームワークです。

## 基本コンセプト

### マルチエージェント合意形成

単一のLLMの回答に依存するのではなく、Consensus Protocol v2は複数のLLM（または単一LLM上の複数ペルソナ）を活用して：

1. 同じプロンプトに対して多様な回答を**生成**
2. 互いの回答を客観的に**評価**
3. スコアを**集約**して最良の回答を特定
4. 合意形成まで**反復**

このアプローチにより、個々のモデルのバイアスを軽減し、より信頼性の高いバランスの取れた出力を生成します。

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    Consensus Protocol v2                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │   LLM A      │    │   LLM B      │    │   LLM C      │      │
│  │ (またはペルソナ)│  │ (またはペルソナ)│  │ (またはペルソナ)│     │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘      │
│         │                   │                   │               │
│         ▼                   ▼                   ▼               │
│  ┌─────────────────────────────────────────────────────┐       │
│  │              生成フェーズ                            │       │
│  │           (並列で回答を生成)                         │       │
│  └─────────────────────────┬───────────────────────────┘       │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────┐       │
│  │              評価フェーズ                            │       │
│  │        (相互評価：各モデルが他を評価)                 │       │
│  └─────────────────────────┬───────────────────────────┘       │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────┐       │
│  │              集約フェーズ                            │       │
│  │       (スコア集計と合意判定)                         │       │
│  └─────────────────────────┬───────────────────────────┘       │
│                            │                                    │
│              ┌─────────────┴─────────────┐                     │
│              │                           │                      │
│              ▼                           ▼                      │
│     ┌────────────────┐          ┌────────────────┐             │
│     │   合意形成     │          │  合意未達成    │             │
│     │    達成        │          │   (反復)       │             │
│     └────────┬───────┘          └────────┬───────┘             │
│              │                           │                      │
│              ▼                           ▼                      │
│     ┌────────────────┐          ┌────────────────┐             │
│     │ 勝者を返却     │          │ フィードバック │             │
│     └────────────────┘          │   ループ       │             │
│                                 └────────────────┘             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## プロトコルフェーズ

### フェーズ1: 生成

設定されたすべてのLLM（またはペルソナ）が同じプロンプトを受け取り、並列で回答を生成します。

**入力:** ユーザープロンプト  
**出力:** LLM回答の配列

```typescript
interface LLMResponse {
  provider: string;    // 例: "ollama", "openrouter", "bedrock"
  model: string;       // 例: "llama3.1", "gpt-4-turbo"
  content: string;     // 生成された回答
  metadata?: object;   // プロバイダー固有のメタデータ
}
```

### フェーズ2: 評価

各LLMは、自分以外のすべてのLLMの回答を4つの基準で評価します：

| 基準 | 説明 | スコア範囲 |
|------|------|-----------|
| **正確性 (Accuracy)** | 事実の正確さと真実性 | 1-10 |
| **関連性 (Relevance)** | プロンプトへの回答の適切さ | 1-10 |
| **完全性 (Completeness)** | 質問のすべての側面のカバー | 1-10 |
| **明確性 (Clarity)** | 明確で構造化されたコミュニケーション | 1-10 |

**合計スコア:** 評価あたり4-40点

```typescript
interface Evaluation {
  evaluator: string;   // 評価を行ったモデル
  target: string;      // 評価対象のモデル
  scores: {
    accuracy: number;
    relevance: number;
    completeness: number;
    clarity: number;
  };
  feedback: string;    // 建設的なフィードバック
  totalScore: number;  // 全スコアの合計 (4-40)
}
```

### フェーズ3: 集約

すべての評価者からのスコアを各回答ごとに集約：

1. 回答ごとの平均スコアを計算
2. 0-1スケールに正規化（40で除算）
3. 合意閾値と比較
4. 勝者を特定（最高平均スコア）

**合意判定:**
```
normalizedScore = averageScore / 40.0
consensusReached = normalizedScore >= consensusThreshold
```

デフォルト閾値: `0.75`（設定可能）

### フェーズ4: 反復（合意未達成の場合）

合意が形成されなかった場合：

1. 最高スコアの回答の評価からフィードバックを抽出
2. 元のプロンプトにフィードバックを追加
3. 強化されたプロンプトでフェーズ1に戻る
4. 合意形成または最大反復回数に達するまで繰り返し

## 設定パラメータ

| パラメータ | 説明 | デフォルト |
|-----------|------|-----------|
| `MAX_ITERATIONS` | 最大合意形成試行回数 | 3 |
| `CONSENSUS_THRESHOLD` | 最小正規化スコア (0-1) | 0.75 |
| `PARALLEL_EXECUTION` | 生成/評価を並列実行 | true |

## サポートプロバイダー

### 標準プロバイダー
- **AWS Bedrock** - Claude、Titan、その他のモデル
- **OpenRouter** - 複数のモデルプロバイダーへのアクセス
- **Ollama** - ローカルモデル実行

### ペルソナベースモード
単一モデルに制限されている場合、ペルソナベースエージェントアンサンブルで複数の視点をシミュレートできます：

- **批判的思考者 (Critical Thinker)** - 欠陥や論理的ギャップを特定
- **創造的思考者 (Creative Thinker)** - 斬新な解決策を提案
- **実用主義者 (Pragmatist)** - 実践的な実装に焦点
- **楽観主義者 (Optimist)** - 機会と利点を強調
- **分析者 (Analyst)** - データ駆動型の客観的分析
- **共感的思考者 (Empathetic Thinker)** - ユーザー中心の視点

カスタムペルソナも定義可能（例：「アインシュタイン」「シャーロック・ホームズ」「物理学者で捻くれ者で、常に斜め上からの視点で物事を考える変態」など）。

## ユースケース

1. **複雑な意思決定** - 難しい問題に対するバランスの取れた視点を取得
2. **コンテンツ生成** - ピアレビューによる高品質化
3. **コードレビュー** - コード品質に対する複数のAI視点
4. **研究統合** - 多様な分析アプローチの組み合わせ
5. **教育コンテンツ** - クロスバリデーションによる正確性確保

## Map-Reduce処理

コンテキストウィンドウを超えるドキュメントの場合、プロトコルはMap-Reduceをサポート：

1. **チャンク化 (Chunk)** - ドキュメントを管理可能な部分に分割
2. **マップ (Map)** - 各チャンクを合意プロトコルで処理
3. **リデュース (Reduce)** - チャンク結果を最終出力に集約

## ベストプラクティス

1. **最低2モデル/ペルソナ** - 相互評価には少なくとも2つの参加者が必要
2. **多様な視点** - より良いカバレッジのために異なるモデルまたは多様なペルソナを使用
3. **適切な閾値** - タスクの重要度に基づいて合意閾値を調整
4. **反復制限** - 最大反復回数で品質と応答時間のバランスを取る

## APIリファレンス

### ConsensusEngine

```typescript
class ConsensusEngine {
  // 合意プロトコルを実行
  async run(prompt: string, sessionId?: string): Promise<ConsensusResult>;
}

interface ConsensusResult {
  responses: LLMResponse[];      // すべての生成された回答
  evaluations: Evaluation[];     // すべての評価
  winner?: LLMResponse;          // 最良の回答（存在する場合）
  consensusReached: boolean;     // 閾値を満たしたかどうか
  iterations: number;            // 実行された反復回数
}
```

## バージョン履歴

| バージョン | 変更点 |
|-----------|--------|
| v2.0 | ペルソナベースエージェントアンサンブルのサポート |
| v1.0 | 初期マルチLLM合意プロトコル |

